# 4.29-5.2

## todo

- 实现新增指令
DIV DIVU MULTU
- 通过lab3-3

> 可选

- 乘除法调用IP核
- 自己实现乘除法器 乘法采用 booth 算法+华莱士、除法采用迭代算法

## done

- 数据相关采取前递处理
- 计组实验实现的指令
MULT, MFLO, MFHI, MTLO, MTHI
BGEZ, BGTZ, BLTZ, BLEZ, JALR
- 自己实现的BLTZAL BGEZAL
- 根据之前的代码实现了 MULTU(未给出无符号信号)
  BLTZAL,BGEZAL(已验证)

## problem

- 为什么ALU操作码要用独热编码,优势?
- reg信号和wire信号的区别

## thinking

- 乘法器部分需要看懂  
- 需要区别有符号乘法和无符号乘法,未给出能进行识别的信号
- 除法先参考计组书来实现
- JAL !!!
无论转移与否,将该分支对应延
迟槽指令之后的指令的 PC 值保存至第 31 号通用寄存器中
- **修改了ID_EXE总线,需要注意宽度一致性**
- 源码对链接跳转做了处理,给exe对应的pc和8作为两个操作数
- **BGEZAL,BLTZAL这两条指令也需要用到rs_value,可能会有数据相关,需要给出冲突的信号** 源码已经处理了
需要传递个信号,在ID阶段就把数据传递给rs(可能rt也需要这样处理)
- 模仿乘法器写个除法器
- 需要注意有符号乘法和除法,特别是有符号除法中商和余数的符号

## tips

- **!!!切记指令译码不要写错,否则debug需要花费大量时间**
- **!!!每次修改exe-mem 和 mem-wb 的总线的时候都要记得修改旁路的数据来源**

## reference

### BLTZAL

如果寄存器 rs 的值小于 0 则转移,否则顺序执行。转移目标由立即数 offset 左移 2 位并进行有符号
扩展的值加上该分支指令对应的延迟槽指令的 PC 计算得到。无论转移与否,将该分支对应延迟槽
指令之后的指令的 PC 值保存至第 31 号通用寄存器中。

### BGEZAL

如果寄存器 rs 的值大于等于 0 则转移,否则顺序执行。转移目标由立即数 offset 左移 2 位并进行有
符号扩展的值加上该分支指令对应的延迟槽指令的 PC 计算得到。无论转移与否,将该分支对应延
迟槽指令之后的指令的 PC 值保存至第 31 号通用寄存器中。

### MFHI

将HI寄存器的值写入寄存器rd中

### MFLO

将LO寄存器的值写入寄存器rd中

## debug

### lab3-2的代码直接跑

```c
--------------------------------------------------------------
[1967795 ns] Error!!!
    reference: PC = 0xbfc3f080, wb_rf_wnum = 0x1f, wb_rf_wdata = 0xbfc3f088
    mycpu    : PC = 0xbfc3f088, wb_rf_wnum = 0x04, wb_rf_wdata = 0xbfc00648
--------------------------------------------------------------
```

### 添加了新的指令,不支持除法,和无符号乘

```c
--------------------------------------------------------------
[1967805 ns] Error!!!
    reference: PC = 0xbfc3f05c, wb_rf_wnum = 0x04, wb_rf_wdata = 0xbfc3f088
    mycpu    : PC = 0xbfc3f088, wb_rf_wnum = 0x04, wb_rf_wdata = 0xbfc3f088
--------------------------------------------------------------
```

### 解决ID段rs数据冲突(只针对inst_BGEZAL和BLTZAL)

其他可能需要的指令做了处理但是没用上(注释了或者不去使用)

``` c
--------------------------------------------------------------
[2291005 ns] Error!!!
    reference: PC = 0xbfc1061c, wb_rf_wnum = 0x15, wb_rf_wdata = 0x00000002
    mycpu    : PC = 0xbfc1061c, wb_rf_wnum = 0x15, wb_rf_wdata = 0xxxxxxxxx
--------------------------------------------------------------
```

0xbfc1061c inst_MFLO  LO_result一直为xxxx
感觉貌似是没有进行过MULT 就使用lo_result出错?
有条div指令,先实现
